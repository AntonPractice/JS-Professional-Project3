stages:
  - build
  - deploy

variables:
  DOCKER_TLS_CERTDIR: "/certs"

# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Docker-in-Docker
services:
  - docker:dind

before_script:
  - docker info

# 1. BUILD - ÑĞ±Ğ¾Ñ€ĞºĞ° Docker-Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°
build:
  stage: build
  script:
    - echo "ğŸ”¨ Building Docker production image..."
    - docker build -t litcode-backend-prod -f Dockerfile.prod .
    - echo "âœ… Docker image built successfully!"
    - echo "ğŸ“¦ Image name: litcode-backend-prod"
  only:
    - main
  when: always

# 2. DEPLOY - Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° Railway Ñ‡ĞµÑ€ĞµĞ· Railway CLI
deploy:
  stage: deploy
  image: node:20-alpine
  script:
    - echo "ğŸš€ Installing Railway CLI..."
    - npm install -g @railway/cli
    
    - echo "ğŸ”‘ Logging into Railway..."
    - railway login --token $RAILWAY_TOKEN
    
    - echo "ğŸ“¡ Deploying to Railway..."
    - railway up --detach
    
    - echo "âœ… Deployment initiated!"
    - echo "ğŸŒ Check your deployment at: https://railway.app/project"
  only:
    - main
  when: manual