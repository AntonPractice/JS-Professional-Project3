stages:
  - build
  - deploy

variables:
  DOCKER_TLS_CERTDIR: "/certs"

services:
  - docker:dind

before_script:
  - docker info

# 1. BUILD - —Å–±–æ—Ä–∫–∞ Docker-–æ–±—Ä–∞–∑–∞
build:
  stage: build
  script:
    - echo "üî® Building Docker production image..."
    - docker build -t litcode-backend-prod -f Dockerfile.prod .
    - echo "‚úÖ Docker image built successfully!"
  only:
    - main

# 2. DEPLOY - –¥–µ–ø–ª–æ–π –Ω–∞ Railway
deploy:
  stage: deploy
  image: node:20-alpine
  before_script:
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Railway CLI
    - npm install -g @railway/cli
  script:
    - echo "üöÄ Starting Railway deployment..."
    
    # –°–ø–æ—Å–æ–± 1: –ü—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
    - export RAILWAY_TOKEN="$RAILWAY_TOKEN"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
    - echo "Token length: ${#RAILWAY_TOKEN} characters"
    
    # –ü—Ä–æ–±—É–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å—Å—è
    - railway login --token "$RAILWAY_TOKEN" || echo "Trying alternative auth method..."
    
    # –ï—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∞—è –∫–æ–º–∞–Ω–¥–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞, –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–±
    - railway whoami 2>/dev/null || {
        echo "Trying to use token as environment variable..."
        RAILWAY_TOKEN="$RAILWAY_TOKEN" railway whoami
      }
    
    # –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –ø—Ä–æ–µ–∫—Ç –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω ID
    - if [ -n "$RAILWAY_PROJECT_ID" ]; then
        echo "Linking to project: $RAILWAY_PROJECT_ID"
        railway link "$RAILWAY_PROJECT_ID"
      fi
    
    # –î–µ–ø–ª–æ–∏–º
    - echo "üì° Deploying project..."
    - railway up --detach
    
    - echo "‚úÖ Deployment initiated!"
    - echo "üåê Check dashboard: https://railway.app"
  only:
    - main
  when: manual